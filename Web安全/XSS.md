# XSS 跨站脚本攻击

Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。

为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。

XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。

而由于直接在用户的终端执行，恶意代码能够直接获取用户的信息，或者利用这些信息冒充用户向网站发起攻击者定义的请求。

在部分情况下，由于输入的限制，注入的恶意脚本比较短。**但可以通过引入外部的脚本，并由浏览器执行，来完成比较复杂的攻击策略。**

这里有一个问题：用户是通过哪种方法“注入”恶意脚本的呢？

+ 来自用户的 UGC 信息
+ 来自第三方的链接
+ URL 参数
+ POST 参数
+ Referer （可能来自不可信的来源）
+ Cookie （可能来自其他子域注入）

## XSS攻击的危害包括：

+ 获取页面数据
+ 获取cookie
+ 劫持前端逻辑
+ 发送请求
+ 偷取网站任意数据
+ 偷取用户资料
+ 偷取用户密码和登陆态
+ 欺骗用户

## XSS攻击类型

### 储存型XSS

 ![](http://dev.biubiupiu.cn/20191130211521.png)

### 反射型XSS

  ![](http://dev.biubiupiu.cn/20191130211554.png)
  **POST 的内容也可以触发反射型 XSS，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。**

### DOM型XSS

![](http://dev.biubiupiu.cn/20191130221147.png)

**DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。**


## 应对策略

### 字符转义

对用户输入数据进行HTML Entity编码（使用转义字符）

![](http://dev.biubiupiu.cn/20191130221502.png)

HTML 中有用的字符实体

![](http://dev.biubiupiu.cn/20191130221532.png)

**前端和后端都需要做好转义**

### 纯前端渲染

+ 浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。
+ 然后浏览器执行 HTML 中的 JavaScript。
+ JavaScript 通过 Ajax 加载业务数据，调用 DOM API 更新到页面上。

在纯前端渲染中，我们会明确的告诉浏览器：下面要设置的内容是文本（.innerText），还是属性（.setAttribute），还是样式（.style）等等。浏览器不会被轻易的被欺骗，执行预期外的代码了。

但纯前端渲染还需注意避免 DOM 型 XSS 漏洞（例如 onload 事件和 href 中的 javascript:xxx 等，请参考下文”预防 DOM 型 XSS 攻击“部分）。

在很多内部、管理系统中，采用纯前端渲染是非常合适的。但对于性能要求高，或有 SEO 需求的页面，我们仍然要面对拼接 HTML 的问题。

### 预防 DOM 型 XSS 攻击

![](http://dev.biubiupiu.cn/20191130232115.png)

### CSP

CSP 的主要目标是减少和报告 XSS 攻击 ，XSS 攻击利用了浏览器对于从服务器所获取的内容的信任。恶意脚本在受害者的浏览器中得以运行，因为浏览器信任其内容来源，即使有的时候这些脚本并非来自于它本该来的地方。

严格的 CSP 在 XSS 的防范中可以起到以下的作用：

+ 禁止加载外域代码，防止复杂的攻击逻辑。
+ 禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。
+ 禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。
+ 禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。
+ 合理使用上报可以及时发现 XSS，利于尽快修复问题。

> CSP可以设置当前页面的资源的来源过滤和上报

[CSP](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy)

### 其他安全措施
+ HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。
+ 验证码：防止脚本冒充用户提交危险操作。